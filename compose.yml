# Cach√© Nginx COMUN A TODOS LOS SITIOS
  nginx:
    image: nginx:alpine
    container_name: nginx_proxy
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/common/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/common/503.html:/usr/share/nginx/html/503.html:ro
    tmpfs:
      - /var/cache/nginx:size=256M,mode=777  # Esto crea el disco en RAM
    networks:
      - idep_net_front
      - idep_net_db
      - idep_net_redis
    depends_on:
      - idep_wp


# STACK SITIO IDEP

# Motor WordPress IDEP
  idep_wp:
    image: wordpress:latest
    container_name: idep_wp
    restart: always

    environment:
      WORDPRESS_DB_HOST: db_idep:3306
      WORDPRESS_DB_USER: ${IDEP_WP_DB_USER}
      WORDPRESS_DB_PASSWORD: ${IDEP_WP_DB_PASSWORD}
      WORDPRESS_DB_NAME: ${IDEP_WP_DB_NAME}
      UPLOAD_LIMIT: 512M
    volumes:
      - ./data/idep/wp:/var/www/html
      - ./data/idep/wp/config/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
      - ./data/idep/wp/config/wp-config.php:/var/www/html/wp-config.php
    depends_on:
      - db_idep
#        condition: service_healthy
    networks:
      - idep_net_front
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/wp-admin/install.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

# Base de datos IDEP
  idep_db:
    image: mariadb:latest
    container_name: idep_db 
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${IDEP_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${IDEP_WP_DB_NAME}
      MYSQL_USER: ${IDEP_WP_DB_USER}
      MYSQL_PASSWORD: ${IDEP_WP_DB_PASSWORD}
    volumes:
      - ./data/idep/db:/var/lib/mysql
    networks:
      - idep_net_db
    healthcheck:
      test: ["CMD-SHELL", "mysql --user=${WORDPRESS_DB_USER} --password=${WORDPRESS_DB_PASSWORD} --execute 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

# Cache Redis IDEP
  idep_redis:
    image: redis:6.2-alpine
    container_name: idep_redis
    restart: unless-stopped
    networks:
      - idep_net_redis

